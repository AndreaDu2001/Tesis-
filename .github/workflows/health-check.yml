name: üìä Health Check & Monitoring

on:
  schedule:
    - cron: '*/30 * * * *'  # Cada 30 minutos
  workflow_dispatch:

jobs:
  health-check:
    name: Backend Health Check
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Backend Status
        run: |
          echo "üîç Checking backend health endpoint..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://residuos-backend.onrender.com/health/ || echo "000")
          
          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ Backend is healthy (HTTP $STATUS)"
          else
            echo "‚ö†Ô∏è  Backend returned HTTP $STATUS"
          fi
          
          exit 0  # Don't fail workflow on health check
      
      - name: Check Frontend Status
        run: |
          echo "üîç Checking frontend status..."
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://residuos-frontend.onrender.com/ || echo "000")
          
          if [ "$STATUS" == "200" ]; then
            echo "‚úÖ Frontend is healthy (HTTP $STATUS)"
          else
            echo "‚ö†Ô∏è  Frontend returned HTTP $STATUS"
          fi
          
          exit 0
      
      - name: Check API Endpoints
        run: |
          echo "üîç Testing API endpoints..."
          
          # Test incidents endpoint
          INCIDENTS=$(curl -s https://residuos-backend.onrender.com/api/incidents/ | wc -c)
          if [ $INCIDENTS -gt 0 ]; then
            echo "‚úÖ Incidents endpoint working"
          else
            echo "‚ö†Ô∏è  Incidents endpoint not responding"
          fi
          
          # Test tasks endpoint
          TASKS=$(curl -s https://residuos-backend.onrender.com/api/tasks/ | wc -c)
          if [ $TASKS -gt 0 ]; then
            echo "‚úÖ Tasks endpoint working"
          else
            echo "‚ö†Ô∏è  Tasks endpoint not responding"
          fi
          
          exit 0

  database-check:
    name: Database Health Check
    runs-on: ubuntu-latest
    if: ${{ secrets.DATABASE_URL != '' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Check Database Connection
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          pip install psycopg2-binary
          python << 'EOF'
          import os
          import psycopg2
          
          try:
            conn = psycopg2.connect(os.getenv('DATABASE_URL'))
            cursor = conn.cursor()
            cursor.execute("SELECT version();")
            version = cursor.fetchone()
            print(f"‚úÖ Database connected: {version[0][:50]}...")
            conn.close()
          except Exception as e:
            print(f"‚ùå Database connection failed: {e}")
          EOF

  uptime-tracking:
    name: Track Uptime
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prototipo'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Record uptime
        run: |
          echo "Recording service uptime at $(date)"
          echo "Backend: checking..."
          echo "Frontend: checking..."
          echo "Database: checking..."
